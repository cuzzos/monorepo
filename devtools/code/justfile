# Code Analysis Devtool - Justfile
#
# AI-powered code analysis using local LLMs via Ollama and Dagger.
# Imported by root justfile - run from repo root with `just <recipe>`.
#
# Getting Help:
#   just --list              # List all available recipes
#   just <recipe> --help     # Show detailed usage for a specific recipe
#
# Prerequisites:
#   OLLAMA_HOST=0.0.0.0:11434 ollama serve &
#   ollama pull gemma3:4b
#
# Note for maintainers (human & AI):
#   When modifying recipes, keep the --help output in sync with actual behavior!

# =============================================================================
# Review Recipes
# =============================================================================

# Run code review prompts on your changes
review *args:
    #!/usr/bin/env bash
    set -euo pipefail
    
    # Parse args
    SAVE=false
    FOCUS=""
    BASE="main"
    NEXT_IS_BASE=false
    
    for arg in {{args}}; do
        if [ "$NEXT_IS_BASE" = true ]; then
            BASE="$arg"
            NEXT_IS_BASE=false
        elif [ "$arg" = "--help" ] || [ "$arg" = "-h" ]; then
            echo "Usage: just review [focus] [--from <base>] [--save]"
            echo ""
            echo "Run code review prompts on your changes."
            echo ""
            echo "Options:"
            echo "  focus        Specific prompt (e.g., for-basic, for-security)"
            echo "  --from BASE  Base branch/commit to diff against (default: main)"
            echo "  --save       Save output to timestamped markdown file"
            echo ""
            echo "Prompts are auto-discovered from: devtools/code/prompts/review-code/"
            echo ""
            echo "Examples:"
            echo "  just review                      # Review changes from main"
            echo "  just review for-security         # Run security-focused review only"
            echo "  just review --from develop       # Review changes from develop branch"
            echo "  just review --from HEAD~5        # Review last 5 commits"
            echo "  just review --save               # Save output to review-YYYY-MM-DD-HHMMSS.md"
            exit 0
        elif [ "$arg" = "--from" ]; then
            NEXT_IS_BASE=true
        elif [ "$arg" = "--save" ]; then
            SAVE=true
        else
            FOCUS="$arg"
        fi
    done
    
    # Compute diff locally (fast)
    DIFF_FILE=$(mktemp)
    trap "rm -f $DIFF_FILE" EXIT
    
    git diff "${BASE}..HEAD" > "$DIFF_FILE"
    
    if [ ! -s "$DIFF_FILE" ]; then
        echo "No changes found between ${BASE} and HEAD"
        exit 0
    fi
    
    # Determine which prompts to run
    if [ -z "$FOCUS" ]; then
        # Discover all prompts in review-code folder
        PROMPTS=$(ls devtools/code/prompts/review-code/for-*.md 2>/dev/null | \
            sed 's|devtools/code/prompts/||g; s|\.md$||g' | \
            tr '\n' ',' | sed 's|,$||')
    else
        PROMPTS="review-code/$FOCUS"
    fi

    echo "ðŸ” Running code review (${BASE}..HEAD)..."
    if [ "$SAVE" = true ]; then
        OUTPUT_FILE="review-$(date +%Y-%m-%d-%H%M%S).md"
        dagger -m ./devtools/code call execute-prompts \
            --diff-file="$DIFF_FILE" \
            --prompts="$PROMPTS" > "$OUTPUT_FILE"
        echo "âœ… Saved to $OUTPUT_FILE"
    else
        dagger -m ./devtools/code call execute-prompts \
            --diff-file="$DIFF_FILE" \
            --prompts="$PROMPTS"
    fi

# =============================================================================
# Summarize Recipes
# =============================================================================

# Summarize changes for teammates
summarize *args:
    #!/usr/bin/env bash
    set -euo pipefail
    
    # Parse args
    SAVE=false
    FOCUS=""
    for arg in {{args}}; do
        if [ "$arg" = "--help" ] || [ "$arg" = "-h" ]; then
            echo "Usage: just summarize [focus] [--save]"
            echo ""
            echo "Summarize code changes for teammates (PR descriptions, release notes)."
            echo ""
            echo "Options:"
            echo "  focus     Specific prompt (e.g., for-diff)"
            echo "  --save    Save output to timestamped markdown file"
            echo ""
            echo "Prompts are auto-discovered from: devtools/code/prompts/summarize-code/"
            echo ""
            echo "Examples:"
            echo "  just summarize           # Run all summarize prompts in the folder"
            echo "  just summarize --save    # Run all and save to summary-YYYY-MM-DD-HHMMSS.md"
            exit 0
        elif [ "$arg" = "--save" ]; then
            SAVE=true
        else
            FOCUS="$arg"
        fi
    done
    
    DIFF_FILE=$(mktemp)
    trap "rm -f $DIFF_FILE" EXIT
    
    git diff main..HEAD > "$DIFF_FILE"
    
    if [ ! -s "$DIFF_FILE" ]; then
        echo "No changes found between main and HEAD"
        exit 0
    fi

    # Determine which prompts to run
    if [ -z "$FOCUS" ]; then
        # Discover all prompts in summarize-code folder
        PROMPTS=$(ls devtools/code/prompts/summarize-code/for-*.md 2>/dev/null | \
            sed 's|devtools/code/prompts/||g; s|\.md$||g' | \
            tr '\n' ',' | sed 's|,$||')
    else
        PROMPTS="summarize-code/$FOCUS"
    fi
    
    echo "ðŸ“ Summarizing changes..."
    if [ "$SAVE" = true ]; then
        OUTPUT_FILE="summary-$(date +%Y-%m-%d-%H%M%S).md"
        dagger -m ./devtools/code call execute-prompts \
            --diff-file="$DIFF_FILE" \
            --prompts="$PROMPTS" > "$OUTPUT_FILE"
        echo "âœ… Saved to $OUTPUT_FILE"
    else
        dagger -m ./devtools/code call execute-prompts \
            --diff-file="$DIFF_FILE" \
            --prompts="$PROMPTS"
    fi

# =============================================================================
# Utility Recipes
# =============================================================================

# Check if Ollama is running and model is available
check-ollama *args:
    #!/usr/bin/env bash
    set -euo pipefail
    
    for arg in {{args}}; do
        if [ "$arg" = "--help" ] || [ "$arg" = "-h" ]; then
            echo "Usage: just check-ollama"
            echo ""
            echo "Verify Ollama is running and the required model is available."
            echo ""
            echo "Checks:"
            echo "  - Ollama server connectivity"
            echo "  - Ollama version"
            echo "  - Number of available models"
            echo "  - Required model (gemma3:4b) presence and size"
            echo ""
            echo "Prerequisites:"
            echo "  OLLAMA_HOST=0.0.0.0:11434 ollama serve"
            echo "  ollama pull gemma3:4b"
            exit 0
        fi
    done
    
    dagger -m ./devtools/code call check-ollama

