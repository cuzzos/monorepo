# Thiccc iOS App Makefile
# Run from thiccc/ root: make -f build/Makefile <target>

# Configurable simulator (can override: make run-sim SIMULATOR='iPhone 17')
SIMULATOR ?= iPhone 16 Pro

.PHONY: build clean open xcode-build run-sim list-sims test check help close-sims logs logs-all run-sim-all coverage coverage-report coverage-check test-rust verify-agent

# Default target: show help
.DEFAULT_GOAL := help

# Show help
help:
	@echo "Thiccc iOS App Build Commands"
	@echo ""
	@echo "Main commands:"
	@echo "  make build       - Build Rust libraries and generate Xcode project"
	@echo "  make xcode-build - Build Rust + iOS app (no Xcode GUI)"
	@echo "  make run-sim     - Build and run in simulator (filtered logs)"
	@echo "  make run-sim-all - Build and run in simulator (all system logs)"
	@echo "  make test        - Run tests"
	@echo "  make open        - Open Xcode project"
	@echo "  make clean       - Clean build artifacts"
	@echo ""
	@echo "Testing & Coverage:"
	@echo "  make test-rust       - Run Rust unit tests only"
	@echo "  make coverage        - Run tests with coverage report (HTML)"
	@echo "  make coverage-report - Open coverage HTML report in browser"
	@echo "  make coverage-check  - Verify 100% line coverage (CI-ready)"
	@echo "  make verify-agent    - Complete validation for AI agents (fast)"
	@echo ""
	@echo "Utilities:"
	@echo "  make check       - Check if everything is set up correctly"
	@echo "  make list-sims   - List available iOS simulators"
	@echo "  make logs        - Stream logs from running app (filtered)"
	@echo "  make logs-all    - Stream ALL system logs (unfiltered)"
	@echo "  make close-sims  - Close all running simulators"
	@echo "  make help        - Show this help message"
	@echo ""
	@echo "Configuration:"
	@echo "  SIMULATOR        - Choose simulator (default: $(SIMULATOR))"
	@echo ""
	@echo "Examples:"
	@echo "  make run-sim SIMULATOR='iPhone 16'"
	@echo "  make test SIMULATOR='iPhone Air'"
	@echo "  make coverage-check  # Verify 100% Rust coverage"
	@echo ""
	@echo "Current settings:"
	@echo "  Simulator: $(SIMULATOR)"

# Full build: Rust libs + shared types + Xcode project
build:
	@echo "ðŸ”„ Generating shared types..."
	@cd shared_types && cargo build
	@echo "ðŸ”¨ Building Rust for iOS..."
	@cd shared && cargo build --release --target aarch64-apple-ios
	@cd shared && cargo build --release --target aarch64-apple-ios-sim
	@echo "ðŸ“± Generating Xcode project..."
	@cd ios && mint run xcodegen xcodegen generate
	@echo "âœ… Build complete!"

# Build iOS app using xcodebuild (no Xcode GUI needed)
xcode-build: build
	@echo "ðŸŽ Building iOS app for simulator..."
	@echo "ðŸ“± Target: $(SIMULATOR)"
	@echo "â³ This may take a minute on first build..."
	@xcodebuild -project ios/Thiccc.xcodeproj \
		-scheme Thiccc \
		-sdk iphonesimulator \
		-destination 'platform=iOS Simulator,name=$(SIMULATOR)' \
		-configuration Debug \
		-showBuildTimingSummary \
		build | tee xcodebuild.log | grep -E "^\*\*|Building|Linking|âš ï¸|error:|warning:"
	@echo "âœ… iOS app build complete!"

# Build and run in simulator
run-sim: xcode-build
	@echo "ðŸ›‘ Shutting down any running simulators..."
	@xcrun simctl shutdown all 2>/dev/null || true
	@echo "ðŸš€ Booting simulator: $(SIMULATOR)..."
	@xcrun simctl boot "$(SIMULATOR)"
	@open -a Simulator
	@sleep 2
	@echo "ðŸ“² Installing app..."
	@APP_PATH=$$(find ~/Library/Developer/Xcode/DerivedData/Thiccc-*/Build/Products/Debug-iphonesimulator -name "Thiccc.app" -type d 2>/dev/null | head -1); \
	if [ -z "$$APP_PATH" ]; then \
		echo "âŒ Could not find Thiccc.app in DerivedData"; \
		echo "Searching for it..."; \
		find ~/Library/Developer/Xcode/DerivedData -name "Thiccc.app" -type d 2>/dev/null | head -5; \
		exit 1; \
	fi; \
	echo "Found app at: $$APP_PATH"; \
	xcrun simctl install booted "$$APP_PATH"
	@echo "â–¶ï¸  Launching app and streaming logs..."
	@echo "ðŸ“‹ Press Ctrl+C to stop watching logs"
	@xcrun simctl launch booted com.cuzzos.Thiccc.Thiccc &
	@sleep 1
	@xcrun simctl spawn booted log stream --level=debug --predicate 'processImagePath CONTAINS "Thiccc"' --style compact

# Build and run in simulator with ALL system logs (unfiltered)
run-sim-all: xcode-build
	@echo "ðŸ›‘ Shutting down any running simulators..."
	@xcrun simctl shutdown all 2>/dev/null || true
	@echo "ðŸš€ Booting simulator: $(SIMULATOR)..."
	@xcrun simctl boot "$(SIMULATOR)"
	@open -a Simulator
	@sleep 2
	@echo "ðŸ“² Installing app..."
	@APP_PATH=$$(find ~/Library/Developer/Xcode/DerivedData/Thiccc-*/Build/Products/Debug-iphonesimulator -name "Thiccc.app" -type d 2>/dev/null | head -1); \
	if [ -z "$$APP_PATH" ]; then \
		echo "âŒ Could not find Thiccc.app in DerivedData"; \
		echo "Searching for it..."; \
		find ~/Library/Developer/Xcode/DerivedData -name "Thiccc.app" -type d 2>/dev/null | head -5; \
		exit 1; \
	fi; \
	echo "Found app at: $$APP_PATH"; \
	xcrun simctl install booted "$$APP_PATH"
	@echo "â–¶ï¸  Launching app and streaming ALL logs..."
	@echo "âš ï¸  This will be very verbose!"
	@echo "ðŸ“‹ Press Ctrl+C to stop watching logs"
	@xcrun simctl launch booted com.cuzzos.Thiccc.Thiccc &
	@sleep 1
	@xcrun simctl spawn booted log stream --level=debug --style compact

# List available simulators
list-sims:
	@echo "Available iOS Simulators:"
	@xcrun simctl list devices available iOS | grep "iPhone\|iPad" || echo "Run 'open /Applications/Xcode.app' to install simulators"

# Run Rust unit tests only (fast)
test-rust:
	@echo "ðŸ§ª Running Rust unit tests..."
	@cd shared && cargo test --all-features
	@echo "âœ… Rust tests passed!"

# Run iOS tests in simulator (slower)
test: build
	@echo "ðŸ§ª Running tests on $(SIMULATOR)..."
	@xcodebuild -project ios/Thiccc.xcodeproj \
		-scheme Thiccc \
		-sdk iphonesimulator \
		-destination 'platform=iOS Simulator,name=$(SIMULATOR)' \
		test

# Run tests with coverage and generate HTML report
coverage:
	@echo "ðŸ§ª Running tests with coverage..."
	@if ! command -v cargo-llvm-cov >/dev/null 2>&1; then \
		echo "âŒ cargo-llvm-cov not found. Installing..."; \
		cargo install cargo-llvm-cov; \
	fi
	@cd shared && cargo llvm-cov --all-features --workspace --html
	@echo "âœ… Coverage report generated!"
	@echo "ðŸ“Š View report: make coverage-report"
	@echo "    or open: shared/target/llvm-cov/html/index.html"

# Open coverage HTML report in browser
coverage-report:
	@echo "ðŸ“Š Opening coverage report..."
	@if [ ! -f shared/target/llvm-cov/html/index.html ]; then \
		echo "âŒ Coverage report not found. Run 'make coverage' first."; \
		exit 1; \
	fi
	@open shared/target/llvm-cov/html/index.html

# Check if coverage meets 100% threshold (fails if below)
coverage-check:
	@echo "ðŸ§ª Running tests with coverage..."
	@if ! command -v cargo-llvm-cov >/dev/null 2>&1; then \
		echo "âŒ cargo-llvm-cov not found. Installing..."; \
		cargo install cargo-llvm-cov; \
	fi
	@echo "ðŸ” Checking coverage threshold (100% line coverage required)..."
	@cd shared && cargo llvm-cov --all-features --workspace --fail-under-lines 100 --ignore-filename-regex "lib.rs"
	@echo "âœ… Coverage meets 100% threshold!"

# Check if everything is set up correctly
check:
	@echo "ðŸ” Checking build environment..."
	@command -v cargo >/dev/null 2>&1 && echo "âœ… Rust/Cargo installed" || echo "âŒ Rust not found"
	@command -v xcodegen >/dev/null 2>&1 && echo "âœ… XcodeGen installed" || echo "âŒ XcodeGen not found"
	@command -v xcodebuild >/dev/null 2>&1 && echo "âœ… Xcode Command Line Tools" || echo "âŒ Xcode not found"
	@rustup target list --installed | grep -q "aarch64-apple-ios" && echo "âœ… iOS target (device)" || echo "âŒ iOS device target missing"
	@rustup target list --installed | grep -q "aarch64-apple-ios-sim" && echo "âœ… iOS target (simulator)" || echo "âŒ iOS simulator target missing"
	@echo ""
	@echo "Available simulators:"
	@xcrun simctl list devices available iOS 2>/dev/null | grep "iPhone\|iPad" | head -5 || echo "âš ï¸  No simulators found - open Xcode to install"

# Close all running simulators
close-sims:
	@echo "ðŸ›‘ Shutting down all simulators..."
	@xcrun simctl shutdown all
	@killall Simulator 2>/dev/null || true
	@echo "âœ… All simulators closed"

# Stream logs from running app (filtered to Thiccc)
logs:
	@echo "ðŸ“‹ Streaming logs from Thiccc app (filtered)..."
	@echo "Press Ctrl+C to stop"
	@xcrun simctl spawn booted log stream --level=debug --predicate 'processImagePath CONTAINS "Thiccc"' --style compact

# Stream ALL system logs (unfiltered)
logs-all:
	@echo "ðŸ“‹ Streaming ALL system logs (unfiltered)..."
	@echo "âš ï¸  This will be very verbose!"
	@echo "Press Ctrl+C to stop"
	@xcrun simctl spawn booted log stream --level=debug --style compact

clean:
	@cargo clean
	@rm -rf shared/build
	@rm -rf ios/build

open:
	@open ios/Thiccc.xcodeproj

# Agent-optimized validation (fast, comprehensive)
verify-agent:
	@echo "ðŸ¤– Running AI Agent Validation..."
	@echo ""
	@echo "1ï¸âƒ£  Running Rust tests..."
	@cd shared && cargo test --all-features --quiet
	@echo "âœ… Tests passed"
	@echo ""
	@echo "2ï¸âƒ£  Checking code coverage..."
	@if ! command -v cargo-llvm-cov >/dev/null 2>&1; then \
		echo "âš ï¸  cargo-llvm-cov not found. Installing..."; \
		cargo install cargo-llvm-cov; \
	fi
	@cd shared && cargo llvm-cov --all-features --workspace --fail-under-lines 100 --ignore-filename-regex "lib.rs" --quiet
	@echo "âœ… 100% coverage achieved"
	@echo ""
	@echo "3ï¸âƒ£  Generating Swift types..."
	@cd shared_types && cargo build --quiet 2>&1 | grep -v "Compiling\|Finished" || true
	@echo "âœ… Swift types generated"
	@echo ""
	@echo "================================"
	@echo "âœ… ALL AGENT CHECKS PASSED"
	@echo "================================"
	@echo ""
	@echo "Ready to hand off to user!"
	@echo ""
